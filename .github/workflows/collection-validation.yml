name: ðŸ§ª Collection Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Executa diariamente Ã s 9h UTC (6h BR)
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  validate-collections:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: ðŸ“¦ Install Newman
      run: |
        npm install -g newman
        npm install -g newman-reporter-html
        npm install -g newman-reporter-htmlextra
        
    - name: âœ… Validate Collection Structure
      run: |
        echo "ðŸ” Validating collection files..."
        
        # Verificar se os arquivos existem
        if [ ! -f "environments/ServeRest-DEV.postman_environment.json" ]; then
          echo "âŒ Environment file not found"
          exit 1
        fi
        
        # Verificar estrutura JSON dos environments
        echo "ðŸ“‹ Validating environment JSON..."
        cat environments/ServeRest-DEV.postman_environment.json | jq empty
        
        echo "âœ… Collection structure validation passed"
        
    - name: ðŸ§ª Run Exploratory Tests
      if: hashFiles('collections/exploratory-tests/*.json') != ''
      run: |
        echo "ðŸš€ Running Exploratory Tests..."
        
        # Criar diretÃ³rio para relatÃ³rios
        mkdir -p reports
        
        # Executar collection se existir
        if [ -f "collections/exploratory-tests/testesExploratorios.json" ]; then
          newman run "collections/exploratory-tests/testesExploratorios.json" \
            -e "environments/ServeRest-DEV.postman_environment.json" \
            --delay-request 1000 \
            --timeout-request 10000 \
            --reporters cli,html,htmlextra \
            --reporter-html-export reports/exploratory-tests-report.html \
            --reporter-htmlextra-export reports/exploratory-tests-detailed.html \
            --reporter-htmlextra-title "Testes ExploratÃ³rios - ServeRest API" \
            --continue-on-error
        else
          echo "â„¹ï¸ Exploratory tests collection not found, skipping..."
        fi
        
    - name: ðŸ“Š Upload Test Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports-${{ matrix.node-version }}
        path: reports/
        retention-days: 30
        
    - name: ðŸ“ˆ Test Results Summary
      if: always()
      run: |
        echo "## ðŸ“Š Test Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Node Version:** ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment:** ServeRest DEV" >> $GITHUB_STEP_SUMMARY
        echo "- **Execution Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "reports" ]; then
          echo "âœ… Test reports generated successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Check the artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test reports generated" >> $GITHUB_STEP_SUMMARY
        fi

  api-health-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ¥ Check ServeRest API Health
      run: |
        echo "ðŸ” Checking ServeRest API availability..."
        
        # Verificar se a API estÃ¡ respondendo
        response=$(curl -s -o /dev/null -w "%{http_code}" https://serverest.dev/usuarios)
        
        if [ $response = "200" ]; then
          echo "âœ… ServeRest API is healthy (HTTP $response)"
        else
          echo "âŒ ServeRest API is not responding properly (HTTP $response)"
          exit 1
        fi
        
        # Verificar endpoints principais
        echo "ðŸ§ª Testing main endpoints..."
        
        endpoints=("/usuarios" "/produtos" "/carrinhos")
        
        for endpoint in "${endpoints[@]}"; do
          status=$(curl -s -o /dev/null -w "%{http_code}" "https://serverest.dev$endpoint")
          if [ $status = "200" ]; then
            echo "âœ… $endpoint: OK ($status)"
          else
            echo "âš ï¸ $endpoint: $status"
          fi
        done
        
    - name: ðŸ“Š API Health Summary
      run: |
        echo "## ðŸ¥ API Health Check Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **API Base URL:** https://serverest.dev" >> $GITHUB_STEP_SUMMARY
        echo "- **Check Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** âœ… Healthy" >> $GITHUB_STEP_SUMMARY
